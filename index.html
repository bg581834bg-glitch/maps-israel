<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>go'maps - ניווט ומפות ישראל</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- ספריות -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ljagis/leaflet-measure@2.1.7/dist/leaflet-measure.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.css"/>
    <style>
        body {
            background: #f6f9ff;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .gomaps-header {
            background: linear-gradient(90deg, #00c6ff 0%, #0072ff 100%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .gomaps-title {
            font-size:2.2rem;
            color:#fff;
            letter-spacing:2px;
            text-shadow: 1px 1px 6px #333;
            font-weight: bold;
        }
        .gomaps-logo {
            border-radius:12px;
            box-shadow:0 2px 8px rgba(0,0,0,0.12);
        }
        /* סרגל צד */
        .sidebar {
            position: fixed;
            top: 80px;
            right: 0;
            width: 340px;
            max-width: 95vw;
            height: calc(100vh - 90px);
            z-index: 9999;
            transition: transform 0.3s;
            border-radius: 18px 0 0 18px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.10);
            padding: 18px 16px 0 16px;
            background: #fff;
            /*overflow-y: auto; */
            height: calc(100vh - 90px);
        }
        .sidebar.closed {
            transform: translateX(100%);
        }
        #toggleSidebar {
            position: fixed;
            top: 120px;
            right: 0;
            z-index: 10001;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(90deg, #00c6ff 0%, #0072ff 100%);
            color: #fff;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: background 0.3s;
        }
        #toggleSidebar:hover {
            background: linear-gradient(90deg, #0072ff 0%, #00c6ff 100%);
            color: #ffe600;
        }
        .card {
            border-radius: 18px !important;
            border: none;
        }
        .form-control-lg {
            border-radius: 10px;
            font-size: 1.1rem;
        }
        .btn-gradient {
            background: linear-gradient(90deg, #00c6ff 0%, #0072ff 100%);
            color: #fff;
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            transition: background 0.3s;
        }
        .btn-gradient:hover {
            background: linear-gradient(90deg, #0072ff 0%, #00c6ff 100%);
            color: #ffe600;
        }

        .leaflet-control-measure-toggle {
            width: 48px !important;
            height: 48px !important;
            font-size: 2rem !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: #ffe600 !important;
            color: #0072ff !important;
            border-radius: 50% !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12) !important;
            border: none !important;
        }
        .leaflet-control-measure-toggle i {
            font-size: 2rem;
        }
        .leaflet-control-measure .leaflet-control-measure-actions button {
            background: #0072ff !important;
            color: #fff !important;
            border-radius: 8px !important;
            border: none !important;
            margin: 2px;
            font-weight: bold;
        }
        .leaflet-control-measure .leaflet-control-measure-actions button:hover {
            background: #00c6ff !important;
            color: #ffe600 !important;
        }
        @media (max-width: 600px) {
            .sidebar { width: 98vw; left: 0; }
            #toggleSidebar { left: -54px; }
        }
        /* תפריט הקשר */
        .context-menu {
            min-width: 160px;
            padding: 5px;
        }
        
        .context-menu button {
            width: 100%;
            padding: 8px;
            margin: 2px 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            text-align: right;
        }
        
        .context-menu button:hover {
            background: linear-gradient(90deg, #00c6ff 0%, #0072ff 100%);
            color: #fff;
        }
        /* עיצוב הוראות נסיעה */
        .direction-step {
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            padding: 10px;
            text-align: right;
        }
        
        .direction-step i {
            color: #0072ff;
            margin-left: 8px;
        }
        
        .direction-step small {
            color: #6c757d;
            display: block;
            margin-right: 24px;
            margin-top: 4px;
        }
        
        #directions {
            padding: 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .direction-step:hover {
            background-color: #e9ecef !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .direction-step.highlighted {
            background-color: #ffe600 !important;
            color: #0072ff;
        }
            .btn-gradient.export-btn {
            background: linear-gradient(90deg, #ff6b6b 0%, #ee5253 100%);
            margin-top: 15px;
            width: 100%;
        }

        .btn-gradient.export-btn:hover {
            background: linear-gradient(90deg, #ee5253 0%, #ff6b6b 100%);
        }
        .btn-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(90deg, #00c6ff 0%, #0072ff 100%);
            color: #fff;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
            transition: all 0.3s;
            margin: 0 4px;
        }

        .btn-circle:hover {
            transform: scale(1.1);
            background: linear-gradient(90deg, #0072ff 0%, #00c6ff 100%);
        }

        .btn-circle.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 18px;
            max-width: 90%;
            width: 500px;
            text-align: center;
        }

        .prayer-text {
            margin: 20px 0;
            text-align: right;
            line-height: 1.6;
        }

        .card-body {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 16px !important;
        }

        #routeInfo {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-height: 180px;
            margin-top: 1rem;
        }

        #directions {
            flex-grow: 1;
            overflow-y: auto;
            min-height: 60px;
            margin-bottom: 10px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 10px;
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            background: white;
            border-top: 1px solid #eee;
            border-radius: 0 0 18px 18px;
            margin: 0;
            flex-shrink: 0;
            padding-top: 12px;
            position: sticky;
            bottom: 0;    
        }

        #routeForm {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        @media (max-width: 600px) {
            .sidebar {
                height: 98vh;
                max-height: 98vh;
                overflow-y: auto;
            }
            .card-body {
                height: calc(98vh - 60px);
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <div id="loader" style="
        position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:99999;
        background: linear-gradient(90deg, #00c6ff 0%, #0072ff 100%);
        display:flex;align-items:center;justify-content:center;flex-direction:column;
        transition: opacity 0.5s;
    ">
        <img src="logo.png" alt="לוגו" style="width:110px;height:110px;box-shadow:0 2px 16px #0072ff44;border-radius:18px;">
        <div style="color:#fff;font-size:2.5rem;font-weight:bold;letter-spacing:2px;text-shadow:1px 1px 8px #333;margin-top:24px;">
            go<span style="color:#ffe600;">'</span>maps
        </div>
    </div>   
    <!-- כותרת עליונה -->
    
    <nav class="navbar mb-2 gomaps-header">
        <div class="container-fluid d-flex justify-content-start align-items-center">
            <img src="logo.png" alt="לוגו" width="56" height="56" class="me-2 gomaps-logo">
            <span class="gomaps-title">
                go<span style="color:#ffe600;">'</span>maps
            </span>
        </div>
    </nav>

    <!-- החלף את האזור של סרגל הצד -->
    
    <button id="toggleSidebar" title="הסתר/הצג סרגל">
        <i class="fas fa-chevron-right"></i>
    </button>
        <div id="sidebar" class="sidebar">
        <div class="card shadow-lg border-0 h-100">
            <div class="card-body p-3 bg-light d-flex flex-column h-100">
            <h4 class="mb-4 text-center fw-bold" style="color:#0072ff; letter-spacing:2px;">
                תכנון מסלול
            </h4>

                <form id="routeForm" class="row g-3">
                    <div class="col-12">
                        <label for="origin" class="form-label fw-bold">מוצא</label>
                        <input type="text" class="form-control form-control-lg" id="origin" required>
                    </div>
                    <div class="col-12">
                        <label for="destination" class="form-label fw-bold">יעד</label>
                        <input type="text" class="form-control form-control-lg" id="destination" required>
                    </div>
                    <div class="col-12 text-center mt-3">
                        <button type="submit" class="btn btn-gradient fw-bold px-5 py-2" style="font-size:1.2rem;">
                            הצג מסלול <i class="fas fa-route ms-2"></i>
                        </button>
                    </div>

                </form>
                     <!-- שנה את הדיב של routeInfo ל: -->
                <div id="routeInfo" class="d-flex flex-column flex-grow-1 mt-4">
                    <div id="routeSummary" class="text-center mb-3"></div>
                    <div id="directions" class="flex-grow-1" style="overflow-y:auto;"></div>
                    <div class="action-buttons pt-3">
                            <button class="btn-circle" onclick="exportToPDF()" title="שמור ל-PDF">
                                <i class="fas fa-file-pdf"></i>
                            </button>
                            <button class="btn-circle" onclick="setDefaultLocation()" title="הגדר מיקום ברירת מחדל">
                                <i class="fas fa-map-marker-alt"></i>
                            </button>
                            <button class="btn-circle" onclick="showPrayer()" title="תפילת הדרך">
                                <i class="fas fa-pray"></i>
                            </button>
                            <button class="btn-circle disabled" title="בקרוב">
                                <i class="fas fa-ellipsis"></i>
                            </button>
                        </div>
                    </div>               
            </div>
        </div>
    </div>

    <!-- מפה -->
    <div class="container-fluid" style="height: calc(100vh - 70px);">
        <div id="map" style="height:100%; border-radius:18px; box-shadow:0 2px 8px rgba(0,0,0,0.08);"></div>
    </div>


    <!-- ספריות JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ljagis/leaflet-measure@2.1.7/dist/leaflet-measure.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.js"></script>

    <script>
    // סרגל צד פתיחה/סגירה
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSidebar');
    toggleBtn.addEventListener('click', function() {
        sidebar.classList.toggle('closed');
        const icon = toggleBtn.querySelector('i');
        icon.classList.toggle('fa-chevron-right');
        icon.classList.toggle('fa-chevron-left');
    });

    // יצירת מפה
    var map = L.map('map', {
        center: [31.77, 35.21],
        zoom: 13,
        zoomControl: true
    });

    // טעינת מיקום ברירת מחדל בטעינת הדף
    const savedLocation = localStorage.getItem('defaultLocation');
    if (savedLocation) {
        const location = JSON.parse(savedLocation);
        map.setView([location.lat, location.lng], 15);
        
        // הצג סמן במיקום ברירת המחדל
        L.marker([location.lat, location.lng], {
            icon: L.divIcon({
                html: '<i class="fas fa-home fa-2x" style="color: #00c6ff;"></i>',
                className: 'home-location',
                iconSize: [20, 20]
            })
        })
        .addTo(map)
        .bindPopup('מיקום ברירת מחדל')
        .openPopup();
    }

    // עדכן את פונקציית setDefaultLocation
    function setDefaultLocation() {
        alert('לחץ על נקודה במפה כדי להגדיר אותה כמיקום ברירת מחדל');
        
        const currentMarker = document.querySelector('.home-location');
        if (currentMarker) {
            currentMarker.remove(); // הסר סמן קודם אם קיים
        }
        
        map.once('click', function(e) {
            const location = {
                lat: e.latlng.lat,
                lng: e.latlng.lng
            };
            
            // שמור במאחסן המקומי
            localStorage.setItem('defaultLocation', JSON.stringify(location));
            
            // הצג סמן חדש
            L.marker([location.lat, location.lng], {
                icon: L.divIcon({
                    html: '<i class="fas fa-home fa-2x" style="color: #00c6ff;"></i>',
                    className: 'home-location',
                    iconSize: [20, 20]
                })
            })
            .addTo(map)
            .bindPopup('מיקום ברירת מחדל')
            .openPopup();
            
            alert('המיקום נשמר בהצלחה!');
        });
    }
    // זיהוי מיקום אוטומטי
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // בדיקה אם המיקום בתוך ישראל (בערך)
            if (lat >= 29.5 && lat <= 33.3 && lng >= 34.2 && lng <= 35.9) {
                map.setView([lat, lng], 15);
                
                // סמן המיקום הנוכחי
                L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: '<i class="fas fa-location-dot fa-2x" style="color: #00c6ff;"></i>',
                        className: 'current-location',
                        iconSize: [20, 20]
                    })
                })
                .addTo(map)
                .bindPopup('המיקום שלך')
                .openPopup();
            }
        }, function(error) {
            console.log("שגיאה בזיהוי מיקום:", error);
        }, {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        });
    }    

    // שכבת אריחים מקומית
    L.tileLayer('http://localhost:8000/tiles/{z}/{x}/{y}.png', {
        minZoom: 6,
        maxZoom: 15,
        attribution: 'Local Tiles'
    }).addTo(map);



    // מינימאפ
    var miniMapLayer = L.tileLayer('http://localhost:8000/tiles/{z}/{x}/{y}.png', {
        minZoom: 6,
        maxZoom: 14
    });
    var miniMap = new L.Control.MiniMap(miniMapLayer, { 
        toggleDisplay: true,
        position: 'bottomleft'  // שינוי המיקום לשמאל למטה
    }).addTo(map);



    // ניווט: ממשק מסלול
    let routeLayer = null;
    function highlightRouteSegment(coordinates) {
        if (highlightedRoute) {
            map.removeLayer(highlightedRoute);
        }

        highlightedRoute = L.geoJSON({
            type: "LineString",
            coordinates: coordinates
        }, {
            style: {
                color: "#ffe600",
                weight: 8,
                opacity: 0.8
            }
        }).addTo(map);

        map.fitBounds(highlightedRoute.getBounds(), {
            padding: [50, 50]
        });
    }

    document.getElementById('routeForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // קבל ערכים מהשדות
        const originVal = document.getElementById('origin').value.trim();
        const destVal = document.getElementById('destination').value.trim();

        // פונקציה לזיהוי קואורדינטות
        function parseLatLng(val) {
            const parts = val.split(',').map(s => s.trim());
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                return [parseFloat(parts[0]), parseFloat(parts[1])];
            }
            return null;
        }

        // פונקציה למציאת עיר לפי שם עברי
        function findCityByHebName(name) {
            return cities.find(city =>
                city.alt_names.some(n => n.trim() === name)
            );
        }

        // המרה של שדה למערך קואורדינטות
        function getCoords(val) {
            let coords = parseLatLng(val);
            if (coords) return coords;
            let city = findCityByHebName(val);
            if (city) return [city.lat, city.lng];
            return null;
        }

        const origin = getCoords(originVal);
        const destination = getCoords(destVal);

        if (!origin || !destination) {
            alert('נא לבחור מוצא ויעד תקינים מתוך הרשימה או מהמפה');
            return;
        }

        // נקה את התוכן הקודם
        const routeSummary = document.getElementById('routeSummary');
        const directionsDiv = document.getElementById('directions');
        if (routeSummary) routeSummary.innerHTML = "מחפש מסלול...";
        if (directionsDiv) directionsDiv.innerHTML = "";

        try {
            const originCoords = `${origin[1]},${origin[0]}`;
            const destCoords = `${destination[1]},${destination[0]}`;
            const osrmUrl = `http://localhost:5000/route/v1/driving/${originCoords};${destCoords}?steps=true&geometries=geojson&overview=full&annotations=true`;
            console.log('OSRM URL:', osrmUrl);

            const res = await fetch(osrmUrl);
            const data = await res.json();
            console.log('OSRM Response:', data);

            if (data.code === "Ok" && data.routes && data.routes.length > 0) {
                // הסר מסלול קודם
                if (routeLayer) map.removeLayer(routeLayer);

                // הצג מסלול
                routeLayer = L.geoJSON(data.routes[0].geometry, {
                    style: {
                        color: "#ff6600",
                        weight: 6,
                        opacity: 0.8
                    }
                }).addTo(map);

                const distance = (data.routes[0].distance / 1000).toFixed(1);
                const duration = Math.round(data.routes[0].duration / 60);

                // עדכון סיכום המסלול
                if (routeSummary) {
                    routeSummary.innerHTML = `מרחק: <b>${distance}</b> ק"מ<br>זמן משוער: <b>${duration}</b> דקות`;
                }

                // הצגת הוראות נסיעה
                if (directionsDiv && data.routes[0].legs[0].steps) {
                    const steps = data.routes[0].legs[0].steps;
                    const directionsHtml = steps.map((step, index) => {
                        const stepDistance = (step.distance / 1000).toFixed(1);

                        let icon = 'arrow-right';
                        let instruction = step.maneuver.instruction || 'המשך ישר';

                        if (step.name) {
                            instruction = instruction.replace('המשך', `המשך ב${step.name}`);
                            instruction = instruction.replace('פנה', `פנה ל${step.name}`);
                        }

                        if (step.maneuver) {
                            switch(step.maneuver.type) {
                                case 'turn':
                                    icon = step.maneuver.modifier === 'right' ? 'arrow-turn-right' : 'arrow-turn-left';
                                    break;
                                case 'arrive':
                                    icon = 'flag-checkered';
                                    instruction = 'הגעת ליעד';
                                    break;
                                case 'depart':
                                    icon = 'play-circle';
                                    instruction = 'התחל מכאן';
                                    break;
                                case 'roundabout':
                                    icon = 'circle-right';
                                    instruction = `היכנס למעגל התנועה ותצא ביציאה ה-${step.maneuver.exit || ''}`;
                                    break;
                            }
                        }

                        return `
                            <div class="direction-step p-2 mb-2 bg-light rounded" 
                                onclick="highlightRouteSegment(${JSON.stringify(step.geometry.coordinates)})"
                                style="cursor:pointer; transition: background-color 0.3s"
                                onmouseover="this.style.backgroundColor='#e9ecef'"
                                onmouseout="this.style.backgroundColor='#f8f9fa'">
                                <i class="fas fa-${icon} me-2" style="color: #0072ff;"></i>
                                <span>${instruction}</span>
                                ${stepDistance > 0 ? `<small class="text-muted d-block me-4">${stepDistance} ק"מ</small>` : ''}
                            </div>
                        `;
                    }).join('');

                    directionsDiv.innerHTML = `
                        <h5 class="mb-3 text-center" style="color:#0072ff;">הוראות נסיעה:</h5>
                        ${directionsHtml}
                    `;
                }

                // תזוזה למרכז המסלול
                map.fitBounds(routeLayer.getBounds());
            } else {
                if (routeSummary) routeSummary.innerHTML = "לא נמצא מסלול. אנא ודא שהנקודות נמצאות בתוך ישראל.";
            }
        } catch (err) {
            console.error('OSRM Error:', err);
            if (routeSummary) routeSummary.innerHTML = "שגיאה בחיפוש המסלול. אנא ודא שהשרת פועל.";
        }
    });

        // משתנים גלובליים לשמירת נקודות
    let startPoint = null;
    let endPoint = null;
    let startMarker = null;
    let endMarker = null;
    let highlightedRoute = null; 

    // יצירת תפריט הקשר
    const contextMenu = L.popup();
    
    // מאזין ללחיצה ימנית
    map.on('contextmenu', function(e) {
        e.originalEvent.preventDefault();
        
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        const content = `
        <div class="context-menu">
            <button onclick="setStartPoint(${lat}, ${lng})">
                <i class="fas fa-play-circle"></i> בחר כנקודת יציאה
            </button>
            <button onclick="setEndPoint(${lat}, ${lng})">
                <i class="fas fa-flag-checkered"></i> בחר כנקודת יעד
            </button>
        </div>
        `;
        
        contextMenu
            .setLatLng(e.latlng)
            .setContent(content)
            .openOn(map);
    });
    
    // פונקציות לטיפול בנקודות
    function setStartPoint(lat, lng) {
        if (startMarker) {
            map.removeLayer(startMarker);
        }
        
        startPoint = [lat, lng];
        startMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                html: '<i class="fas fa-play-circle fa-2x" style="color: #00c6ff;"></i>',
                className: 'start-marker',
                iconSize: [20, 20]
            })
        }).addTo(map)
        .bindPopup('נקודת יציאה');
        
        document.getElementById('origin').value = `${lat}, ${lng}`;
        contextMenu.close();
    }
    
    function setEndPoint(lat, lng) {
        if (endMarker) {
            map.removeLayer(endMarker);
        }
        
        endPoint = [lat, lng];
        endMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                html: '<i class="fas fa-flag-checkered fa-2x" style="color: #0072ff;"></i>',
                className: 'end-marker',
                iconSize: [20, 20]
            })
        }).addTo(map)
        .bindPopup('נקודת יעד');
        
        document.getElementById('destination').value = `${lat}, ${lng}`;
        contextMenu.close();
    }

// החלף את פונקציית exportToPDF
    async function exportToPDF() {
        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            // ודא שכל האריחים נטענו
            await new Promise(resolve => {
                const checkTiles = setInterval(() => {
                    const tiles = document.querySelectorAll('.leaflet-tile');
                    const loadedTiles = Array.from(tiles).every(tile => tile.complete && tile.naturalWidth > 0);
                    if (loadedTiles) {
                        clearInterval(checkTiles);
                        resolve();
                    }
                }, 100);
            });

            // צלם את המפה בלבד
            const mapElement = document.getElementById('map');
            const canvas = await html2canvas(mapElement, {
                useCORS: true,
                allowTaint: true,
                backgroundColor: "#fff",
                scale: 2
            });

            // הוסף את התמונה ל-PDF
            const imgData = canvas.toDataURL('image/jpeg', 1.0);
            // גודל A4: 210x297 מ"מ, נשמור על יחס גובה-רוחב של המפה
            const pdfWidth = 190;
            const pdfHeight = pdfWidth * (mapElement.offsetHeight / mapElement.offsetWidth);
            pdf.addImage(imgData, 'JPEG', 10, 10, pdfWidth, pdfHeight);

            pdf.save('map.pdf');
        } catch (err) {
            alert('שגיאה ביצירת PDF');
            console.error(err);
        }
    }

    // הוסף בחלק של הסקריפטים
    function setDefaultLocation() {
        alert('לחץ על נקודה במפה כדי להגדיר אותה כמיקום ברירת מחדל');
        map.once('click', function(e) {
            localStorage.setItem('defaultLocation', JSON.stringify({
                lat: e.latlng.lat,
                lng: e.latlng.lng
            }));
            alert('המיקום נשמר בהצלחה!');
        });
    }

    function showPrayer() {
        document.getElementById('prayerModal').style.display = 'flex';
    }

    function closePrayer() {
        document.getElementById('prayerModal').style.display = 'none';
    }

    </script>
        <div id="prayerModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <h3>תפילת הדרך</h3>
            <div class="prayer-text">
                יְהִי רָצוֹן מִלְפָנֶיךָ יְיָ אֱלֹהֵינוּ וֵאלֹהֵי אֲבוֹתֵינוּ,
שֶׁתּוֹלִיכֵנוּ לְשָׁלוֹם וְתַצְעִידֵנוּ לְשָׁלוֹם וְתַדְרִיכֵנוּ לְשָׁלוֹם (וְתִסְמְכֵנוּ לְשָׁלוֹם),
וְתַגִּיעֵנוּ לִמְחוֹז חֶפְצֵנוּ לְחַיִּים וּלְשִׂמְחָה וּלְשָׁלוֹם.
(אם דעתו לחזור מיד אומר וְתַחְזִירֵנוּ לְשָׁלוֹם)
וְתַצִּילֵנוּ מִכַּף כָּל אוֹיֵב וְאוֹרֵב וְלִסְטִים וְחַיּוֹת רָעוֹת בַּדֶּרֶךְ,
וּמִכָּל מִינֵי פֻּרְעָנֻיּוֹת הַמִּתְרַגְּשׁוֹת לָבוֹא לָעוֹלָם,
(וְתִשְׁלַח בְּרָכָה וְהַצְלָחָה בְּכָל מַעֲשֵׂה יָדֵינוּ)[1],
וְתִתְּנֵנוּ לְחֵן וּלְחֶסֶד וּלְרַחֲמִים בְּעֵינֶיךָ וּבְעֵינֵי כָל רֹאֵינוּ,
וְתִשְׁמַע קוֹל תַּחֲנוּנֵינוּ.
כִּי אֵל שׁוֹמֵעַ תְּפִלָּה וְתַחֲנוּן אַתָּה.
בָּרוּךְ אַתָּה יְיָ שׁוֹמֵעַ תְּפִלָּה:
(יש שאין חותמים בשם, אלא כשהולכים במקום סכנה, כגון מקום גדודי חיות או ליסטים, ויש מברכים רק בנסיעה של 72 דקות, כפסיקת הרב עובדיה)



יש מוסיפים לאחר התפילה:
כִּי מַלְאָכָיו יְצַוֶּה לָּךְ לִשְׁמָרְךָ בְּכָל דְּרָכֶיךָ. (תהלים צא, יא)

יְיָ יִשְׁמָר צֵאתְךָ וּבוֹאֶךָ מֵעַתָּה וְעַד עוֹלָם. (תהלים קכא, ח)

ב וְיַעֲקֹב הָלַךְ לְדַרְכּוֹ וַיִּפְגְּעוּ בוֹ מַלְאֲכֵי אֱלֹהִים. ג וַיֹּאמֶר יַעֲקֹב כַּאֲשֶׁר רָאָם מַחֲנֵה אֱלֹקים זֶה וַיִּקְרָא שֵׁם הַמָּקוֹם הַהוּא מַחֲנָיִם. (בראשית לב, ב-ג) (ראם ר"ת רפאל אוריאל מיכאל):

כד יְבָרֶכְךָ יְיָ וְיִשְׁמְרֶךָ.     כה יָאֵר יְיָ פָּנָיו אֵלֶיךָ וִיחֻנֶּךָּ.     כו יִשָּׂא יְיָ פָּנָיו אֵלֶיךָ וְיָשֵׂם לְךָ שָׁלוֹם. (במדבר ו, כד-כו)


                <!-- הוסף את הטקסט המלא של תפילת הדרך -->
            </div>
            <button class="btn btn-gradient" onclick="closePrayer()">סגור</button>
        </div>
    </div>
<script>
let cities = [];
let originInput = document.getElementById('origin');
let destInput = document.getElementById('destination');

// טען את רשימת הערים
fetch('cities.json')
  .then(res => res.json())
  .then(data => {
    cities = data;
    enableAutocomplete(originInput);
    enableAutocomplete(destInput);
  });

function enableAutocomplete(input) {
    let currentFocus;
    input.addEventListener("input", function(e) {
        let val = this.value;
        closeAllLists();
        if (!val) return false;
        currentFocus = -1;
        let list = document.createElement("div");
        list.setAttribute("class", "autocomplete-items");
        list.style.position = "absolute";
        list.style.right = "0";
        list.style.left = "0";
        list.style.zIndex = "10000";
        this.parentNode.appendChild(list);

        let matches = cities.filter(city =>
            city.name.includes(val) ||
            city.alt_names.some(n => n.includes(val))
        ).slice(0, 10);

        matches.forEach(city => {
            let item = document.createElement("div");
            let hebName = city.alt_names.find(n => /[\u0590-\u05FF]/.test(n)) || city.name;
            item.innerHTML = `<strong>${hebName}</strong>`;
            item.addEventListener("click", function(e) {
                input.value = hebName;
                closeAllLists();
            });
            list.appendChild(item);
        });
    });

    input.addEventListener("keydown", function(e) {
        let items = this.parentNode.querySelectorAll(".autocomplete-items div");
        if (!items.length) return;
        if (e.keyCode == 40) { // down
            currentFocus++;
            addActive(items);
        } else if (e.keyCode == 38) { // up
            currentFocus--;
            addActive(items);
        } else if (e.keyCode == 13) { // enter
            e.preventDefault();
            if (currentFocus > -1) {
                items[currentFocus].click();
            }
        }
    });

    function addActive(items) {
        if (!items) return false;
        removeActive(items);
        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = items.length - 1;
        items[currentFocus].classList.add("autocomplete-active");
    }
    function removeActive(items) {
        for (let item of items) item.classList.remove("autocomplete-active");
    }
    function closeAllLists(elmnt) {
        let items = document.querySelectorAll(".autocomplete-items");
        for (let item of items) {
            if (elmnt != item && elmnt != input) item.parentNode.removeChild(item);
        }
    }
    document.addEventListener("click", function (e) {
        closeAllLists(e.target);
    });
}
</script>
<style>
.autocomplete-items {
    border: 1px solid #d4d4d4;
    border-bottom: none;
    border-top: none;
    z-index: 99;
    background: #fff;
    max-height: 250px;
    overflow-y: auto;
}
.autocomplete-items div {
    padding: 10px;
    cursor: pointer;
    background-color: #fff;
    border-bottom: 1px solid #d4d4d4;
    text-align: right;
}
.autocomplete-items div:hover, .autocomplete-active {
    background-color: #e9ecef !important;
}
</style>
<script>
window.addEventListener('load', function() {
    const loader = document.getElementById('loader');
    loader.style.opacity = 0;
    setTimeout(() => loader.style.display = 'none', 500);
});
</script>
</body>
</html>